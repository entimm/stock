<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个股趋势涨幅榜</title>
    <style>
        table {
            border-collapse: collapse;
            width: max-content;
        }
        td, th {
            border: 1px solid rgba(0, 0, 0, 0.23);
            width: 100px;
            text-align: center;
            cursor: pointer;
        }
        th {
            background-color: black;
            color: white;
            position: sticky;
            top: 0;
        }
        #grid-container {
            width: 100%;
            overflow-x: auto;
        }
        .fixed-links {
          margin: 10px;
        }
        .highlight {
          color: #FF5733;
          font-weight: bold;
          font-size: 20px;
          text-decoration: underline;
        }
        #tooltip {
          position: fixed;
          background-color: #fff;
          border: 1px solid #ccc;
          padding: 10px;
          font-size: 20px;
          width: 1640px;
          height: 340px;
        }
        table tr:nth-child(11) {
          border-bottom: 4px solid #FF0000;
        }
        table tr:nth-child(21) {
          border-bottom: 4px solid #FF4500;
        }
        table tr:nth-child(31) {
          border-bottom: 4px solid #FFA500;
        }
        table tr:nth-child(41) {
          border-bottom: 4px solid #FFD700;
        }
        table tr:nth-child(51) {
          border-bottom: 4px solid #FFFF00;
        }
        table tr:nth-child(61) {
          border-bottom: 4px solid #ADFF2F;
        }
        table tr:nth-child(71) {
          border-bottom: 4px solid #7FFF00;
        }
        table tr:nth-child(81) {
          border-bottom: 4px solid #00FF00;
        }
        table tr:nth-child(91) {
          border-bottom: 4px solid #008000;
        }
        td {
            position: relative;
        }
        .dot::after {
            content: "";
            position: absolute;
            bottom: 0;
            right: 0;
            width: 6px;
            height: 6px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        .red-dot1::after {
            background-color: #ffcccc;
        }
        .red-dot2::after {
            background-color: #ff0000;
        }
        .red-dot3::after {
            background-color: #f500ff;
        }
        .green-dot1::after {
            background-color: #ccffcc;
        }
        .green-dot2::after {
            background-color: #00ff00;
        }
        .green-dot3::after {
            background-color: #16b9de;
        }
        #myDialog {
            height: 80%;
            width: 80%;
            border: none;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6);
        }
        .close-button {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
            font-size: 30px;
            font-weight: bolder;
            color: red;
        }
        .select-cell {
            border: 3px solid red;
        }
    </style>
</head>
<body>
    <div class="fixed-links">
        {% for value in ma_list %}
            <a href="?ma={{value}}&year={{year}}&direction={{direction}}" {% if value == ma %}class="highlight"{% endif %}>{{value}}</a>
        {% endfor %}
        {% for value in year_list %}
            <a href="?ma={{ma}}&year={{value}}&direction={{direction}}" {% if value == year %}class="highlight"{% endif %}>{{value}}</a>
        {% endfor %}
        {% for key, value in direction_list.items() %}
            <a href="?ma={{ma}}&year={{year}}&direction={{key}}" {% if direction == key %}class="highlight"{% endif %}>{{value['name']}}</a>
        {% endfor %}
    </div>

    <dialog id="myDialog" style="overflow: hidden;">
        <span class="close-button" onclick="closeDialog()">×</span>
        <iframe id="iframeContent" style="width: 100%; height: 100%; border: none;"></iframe>
    </dialog>

    <div id="grid-container">
        <table id="grid"></table>
        <div id="tooltip" style="display:none;"></div>
    </div>
    <script>
        let data = {{ data | safe }};
        let selectedCell = null
        const myDialog = document.getElementById('myDialog');

        function renderGrid() {
            let table = document.getElementById('grid');
            table.innerHTML = '';

            // 添加表头
            let thead = document.createElement('thead');
            let headerRow = document.createElement('tr');
            for (let colName in data) {
                let headerCell = document.createElement('th');
                headerCell.textContent = colName;
                headerRow.appendChild(headerCell);
            }
            thead.appendChild(headerRow);
            table.appendChild(thead);

            let tbody = document.createElement('tbody');

            // 以最大列长度为标准，添加数据行
            let maxRows = Math.max(...Object.values(data).map(col => col.length));
            for (let i = 0; i < maxRows; i++) {
                let row = document.createElement('tr');
                for (let colName in data) {
                    let cell = document.createElement('td');
                    row.appendChild(cell);
                    let value = data[colName][i] || "";
                    value = value.split('|');
                    cell.textContent = value[0];
                    if (cell.textContent === "") {
                        cell.classList.add("table-empty" + parseInt(i / 20));
                        continue;
                    }
                    addDotClass(cell, value[2])
                    cell.setAttribute('v', `${value[2]} # ${value[3]}`);
                    cell.setAttribute('symbol', value[1]);
                    cell.addEventListener('click', function() {
                        var cellRect = cell.getBoundingClientRect();

                        var clickX = event.clientX - cellRect.left;

                        if (clickX < cellRect.width / 2) {
                            highlightCells(cell.textContent);
                        } else {
                            setSelectedCell(cell)
                            openDialog(`/?symbol=${value[1]}&period=F5`);
                        }
                    });
                    cell.addEventListener('mouseover', function() {
                        show_tooltip(this)
                        setSelectedCell(this)
                    });
                }
                tbody.appendChild(row);
            }
            table.appendChild(tbody);
        }

        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 3; i++) {
                color += letters[Math.floor(Math.random() * 6) + 8]; // 从8到F中选择亮色
            }
            return color;
        }

        function highlightCells(value) {
            let cells = document.querySelectorAll('td');
            color = getRandomColor();
            for (let cell of cells) {
                if (cell.textContent === value) {
                    cell.style.backgroundColor = cell.style.backgroundColor ? "" : color;
                }
            }
        }

        function getExchangeCode(symbol) {
            let exchangeCode = symbol.slice(0, 2);

            if (exchangeCode === "60" || exchangeCode === "68") {
                return `sh${symbol}`;
            } else if (exchangeCode === "00" || exchangeCode === "30") {
                return `sz${symbol}`;
            } else if (exchangeCode === "43" || exchangeCode === "83" || exchangeCode === "87") {
                return `bj${symbol}`;
            } else {
                return symbol;
            }
        }

        function show_tooltip(cell) {
          let symbol = cell.getAttribute('symbol');
          let code = getExchangeCode(symbol)
          tooltip.textContent = cell.getAttribute('v');

          tooltip.appendChild(document.createElement('br'));

          let img1 = document.createElement("img");
          img1.src = `https://image2.sinajs.cn/newchart/min/n/${code}.gif`;
          tooltip.appendChild(img1);
          let img2 = document.createElement("img");
          img2.src = `https://image2.sinajs.cn/newchart/daily/n/${code}.gif`;
          tooltip.appendChild(img2);
          let img3 = document.createElement("img");
          img3.src = `https://image2.sinajs.cn/newchart/weekly/n/${code}.gif`;
          tooltip.appendChild(img3);

          // 计算tooltip的位置

          // 获取屏幕的宽度和高度
          var screenWidth = window.innerWidth;
          var screenHeight = window.innerHeight;

        if (event.clientY <= screenHeight / 2) {
          // 右下角
          tooltip.style.left = screenWidth - tooltip.offsetWidth + 'px';
          tooltip.style.top = screenHeight - tooltip.offsetHeight + 'px';
        } else {
          // 右上角
          tooltip.style.left = screenWidth - tooltip.offsetWidth + 'px';
          tooltip.style.top = '0px';

        }

          tooltip.style.display = 'block';
        }

        function openDialog(url) {
            var iframe = document.getElementById('iframeContent');
            iframe.src = url;

            myDialog.showModal();

            document.addEventListener('click', handleClickOutside);
        }


        function closeDialog() {
            myDialog.close();
            document.removeEventListener('click', handleClickOutside);
        }

        function handleClickOutside(event) {
            if (event.target === myDialog) {
                closeDialog();
            }
        }

        function addDotClass(element, price) {
            const dotClasses = [
                { condition: price >= 15, className: 'red-dot3' },
                { condition: price >= 9.6, className: 'red-dot2' },
                { condition: price >= 5, className: 'red-dot1' },
                { condition: price <= -5, className: 'green-dot1' },
                { condition: price <= -9, className: 'green-dot2' },
                { condition: price <= -15, className: 'green-dot3' },
            ];

            dotClasses.forEach((dotClass) => {
                if (dotClass.condition) {
                    element.classList.add('dot', dotClass.className);
                }
            });
        }

        renderGrid();

        function getAdjacentCell(cell, direction) {
          if (!cell) return;
          var row = cell.parentNode.rowIndex;
          var col = cell.cellIndex;

          var table = document.getElementById("grid");
          var numRows = table.rows.length;
          var numCols = table.rows[0].cells.length;

          switch (direction) {
            case "ArrowUp":
              return row > 0 ? table.rows[row - 1].cells[col] : null;
            case "ArrowRight":
              return col < numCols - 1 ? table.rows[row].cells[col + 1] : null;
            case "ArrowDown":
              return row < numRows - 1 ? table.rows[row + 1].cells[col] : null;
            case "ArrowLeft":
              return col > 0 ? table.rows[row].cells[col - 1] : null;
            default:
              return null;
          }
        }

        function setSelectedCell(cell) {
            if (selectedCell) {
                selectedCell.classList.remove('select-cell')
            }
            selectedCell = cell
            cell.classList.add('select-cell')
        }

        window.addEventListener('message', function(event) {
          if (event.data === 'close_me') {
            closeDialog();
          }
          if (['ArrowRight', 'ArrowDown', 'ArrowLeft', 'ArrowUp'].includes(event.data)) {
            let cell = getAdjacentCell(selectedCell, event.data)
            if (cell) {
                let symbol = cell.getAttribute('symbol');
                if (symbol) {
                    var iframe = document.getElementById('iframeContent');
                    iframe.src = iframe.contentWindow.document.URL.replace(/\d{6}/, symbol);
                    setSelectedCell(cell);
                }
            }
          }
        });

        document.addEventListener('keydown', function (e) {
          if (e.code === 'ArrowUp' || e.code === 'ArrowDown' || e.code === 'ArrowLeft' || e.code === 'ArrowRight') {
            let cell = getAdjacentCell(selectedCell, e.code)
            if (cell) {
                setSelectedCell(cell);
                let symbol = cell.getAttribute('symbol');
                show_tooltip(cell);
            }
          }
          if (e.code === 'Space') {
            if (selectedCell) {
                let symbol = selectedCell.getAttribute('symbol');
                if (symbol) {
                    openDialog(`/?symbol=${symbol}&period=F5`);
                }
            }
          }
        });

    </script>
</body>
</html>