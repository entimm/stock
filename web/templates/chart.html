{% extends '_layout.html' %}
{% block head %}
  <title>K线图</title>
  <style>
    html {
      background: #FFFFFF;
      height: 100%;
    }

    body {
      margin: 0;
      height: 100%;
    }

    #chart {
      height: 100%;
    }

    .fixed-links1 {
      position: absolute;
      top: 0;
      right: 0;
      margin: 20px 100px;
      z-index: 9999;
    }

    .fixed-links1 a {
      margin: 0 2px;
    }

    .fixed-links2 {
      position: absolute;
      top: 50px;
      right: 0;
      margin: 20px 100px;
      z-index: 9999;
    }

    .fixed-links2 .symbol-name {
      font-size: 30px;
    }

    .fixed-links2 .symbol {
      font-size: 20px;
    }

    .highlight {
      color: #FF5733;
      font-weight: bold;
      font-size: 20px;
      text-decoration: underline;
    }
  </style>
{% endblock %}
{% block content %}
  <div class="fixed-links1">
    {% for period_key, period_name in period_list.items() %}
      <a href="/chart?symbol={{ symbol }}&period={{ period_key }}&req_real={{ req_real }}" {% if period_key == period %}class="highlight"{% endif %}>{{ period_name }}</a>
    {% endfor %}
    <a href="/chart?symbol={{ symbol }}&period={{ period }}&req_real=0" {% if req_real == 0 %}class="highlight"{% endif %}>本地</a>
    <a href="/chart?symbol={{ symbol }}&period={{ period }}&req_real=1" {% if req_real == 1 %}class="highlight"{% endif %}>实时</a>
  </div>
  <div class="fixed-links2">
    <span class="symbol">{{ symbol }} - </span><span class="symbol-name">{{ symbol_name }}</span>
  </div>
  <div id="chart"></div>

  <!-- FAB Search Button -->
  <div class="fixed-action-btn" style="bottom: 24px; left: 24px;">
    <a class="btn-floating btn-large waves-effect waves-light teal" onclick="openSearchDialog()">
      搜索
    </a>
  </div>

  <!-- Modal Structure -->
  <div id="search-dialog" class="modal">
    <div class="modal-content">
      <h4>Search</h4>
      <div class="input-field">
        <input type="text" id="search-input" placeholder="Search...">
        <label for="search-input">Type your search here</label>
      </div>
      <div id="search-results" class="collection"></div>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close waves-effect waves-green btn-flat" onclick="closeSearchDialog()">Close</a>
    </div>
  </div>
{% endblock %}
{% block footer %}
  <script>
    if (window.self !== window.top) {
      let headerElement = document.querySelector('header');
      if (headerElement) {
        headerElement.style.display = 'none';
      }
    }
  </script>
  <script src="/static/klinecharts.min.js"></script>
  <script>
    let chart = klinecharts.init('chart', {
      timezone: 'Asia/Shanghai',
      customApi: {
        formatDate: function (dateTimeFormat, timestamp, format, type) {
          return timestamp
        }
      }
    })
    chart._chartStore._timeScaleStore.setBarSpaceLimitConfig(0.01, 20)
    chart.createIndicator({
      name: 'MA',
      precision: 3,
      calcParams: [5, 10, 20, 60, 240, 480, 960],
      styles: {
        lines: [
          {style: 'solid', size: 0.5, color: '#930606'},
          {style: 'solid', size: 0.5, color: '#ECAB07'},
          {style: 'solid', size: 0.5, color: '#EF15DE'},
          {style: 'solid', size: 1, color: '#16de45'},
          {style: 'solid', size: 0.5, color: '#6e28e5'},
          {style: 'solid', size: 0.5, color: '#e50b33'},
          {style: 'solid', size: 0.5, color: '#16b9de'},
        ]
      }
    }, false, {id: 'candle_pane'})
    chart.createIndicator('VOL')
    chart.createIndicator('MACD')
    chart.setStyles({
      // 网格线
      grid: {
        show: true,
        horizontal: {
          show: true,
          size: 1,
          color: '#F0F0F0',
          style: 'solid',
        },
        vertical: {
          show: true,
          size: 1,
          color: '#F0F0F0',
          style: 'solid',
        }
      },
      candle: {
        // 蜡烛图类型 'candle_solid'|'candle_stroke'|'candle_up_stroke'|'candle_down_stroke'|'ohlc'|'area'
        type: 'candle_solid',
        bar: {
          upColor: '#F21414',
          downColor: '#08B536',
          noChangeColor: '#888888',
          upBorderColor: '#F21414',
          downBorderColor: '#08B536',
          noChangeBorderColor: '#888888',
          upWickColor: '#F21414',
          downWickColor: '#08B536',
          noChangeWickColor: '#888888'
        },
      },
      indicator: {
        bars: [{
          // 'fill' | 'stroke' | 'stroke_fill'
          style: 'fill',
          // 'solid' | 'dashed'
          borderStyle: 'solid',
          borderSize: 1,
          borderDashedValue: [2, 2],
          upColor: '#F21414',
          downColor: '#08B536',
          noChangeColor: '#888888'
        }],
        lastValueMark: {
          show: true,
        },
      }
    });

    chart._chartStore.getTimeScaleStore().zoom(1000)
    chart.applyNewData({{ kline_list | tojson }})


    function resizeChart() {
      chart.resize()
    }

    window.addEventListener('resize', resizeChart);
    window.addEventListener('load', resizeChart);


  </script>
  <script src="/static/jquery-3.7.1.min.js"></script>
  <script src="/static/materialize.min.js"></script>
  <script>
    let select_list = [];

    $(document).ready(function () {
      fetch(`/symbol_list`).then(response => response.json())
        .then(data => {
          select_list = data;
        })
      $('.modal').modal();
    });

    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    let selectedIndex = -1;

    function openSearchDialog() {
      $('#search-dialog').modal('open');
      searchInput.focus();
      selectedIndex = -1;
      updateSelectedResult();
    }

    function closeSearchDialog() {
      $('#search-dialog').modal('close');
      searchInput.value = '';
      searchResults.innerHTML = '';
      selectedIndex = -1;
    }

    searchInput.addEventListener('input', function () {
      const query = searchInput.value.toLowerCase();
      const filteredResults = select_list.filter(item =>
        item.key.toLowerCase().includes(query) || item.value.toLowerCase().includes(query)
      );
      displayResults(filteredResults);
    });

    function displayResults(results) {
      searchResults.innerHTML = '';

      if (results.length > 0) {
        results.forEach((result, index) => {
          const listItem = document.createElement('a');
          listItem.href = '#!';
          listItem.classList.add('collection-item');
          listItem.innerText = `${result.key} - ${result.value}`;
          listItem.addEventListener('click', function () {
            searchInput.value = result.key;
            window.location.href = document.URL.replace(/\d{6}/, searchInput.value)
            closeSearchDialog();
          });

          listItem.addEventListener('mouseover', function () {
            selectedIndex = index;
            updateSelectedResult();
          });

          searchResults.appendChild(listItem);
        });
      } else {
        const noResultsItem = document.createElement('div');
        noResultsItem.classList.add('collection-item');
        noResultsItem.innerText = 'No results found';
        searchResults.appendChild(noResultsItem);
      }

      updateSelectedResult();
    }

    function updateSelectedResult() {
      const results = searchResults.getElementsByClassName('collection-item');
      for (let i = 0; i < results.length; i++) {
        results[i].classList.remove('active');
      }

      if (selectedIndex >= 0 && selectedIndex < results.length) {
        results[selectedIndex].classList.add('active');
      }
    }
  </script>

  <script>
    document.addEventListener('keydown', function () {
      if ($('#search-dialog').hasClass('open')) {
        const results = searchResults.getElementsByClassName('collection-item');

        if (event.key === 'ArrowUp') {
          selectedIndex = Math.max(selectedIndex - 1, 0);
        } else if (event.key === 'ArrowDown') {
          selectedIndex = Math.min(selectedIndex + 1, results.length - 1);
        } else if (event.key === 'Enter') {
          if (selectedIndex >= 0 && selectedIndex < results.length) {
            searchInput.value = results[selectedIndex].innerText.split(' - ')[0];
            window.location.href = document.URL.replace(/\d{6}/, searchInput.value)
            closeSearchDialog();
          }
        }
        console.log(selectedIndex)
        updateSelectedResult();
        return;
      }

      if (['Escape', 'Space'].includes(event.code)) {
        window.parent.postMessage('close_me', '*');
      }
      if (['ArrowRight', 'ArrowDown', 'ArrowLeft', 'ArrowUp'].includes(event.code)) {
        window.parent.postMessage(`${event.code}`, '*');
      }
    });
  </script>
{% endblock %}